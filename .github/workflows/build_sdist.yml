# This workflow builds the sdist on 3.13 and then installs that same sdist on

name: Create sdist install and test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12","3.13"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Build sdist
      run: |
        set -x
        pip install --upgrade pip
        pip install build
        pip freeze

        python -m build . --sdist

    - uses: actions/upload-artifact@v4
      with:
        name: the-sdist-${{ matrix.python-version }}
        path: dist/

  install-and-test:

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12","3.13"]
    needs: build
    steps:
    - uses: actions/checkout@v4
    - uses: actions/download-artifact@v4
      with:
        name: the-sdist-${{ matrix.python-version }}
        path: dist/

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies and sdist
      run: |
        set -x
        pip install --upgrade pip
        # Install runtime deps first so sdist is built against same NumPy we run with.
        pip install "numpy>=1.26.4" "scipy>=1.15.0" "joblib>=1.5.0"
        pip install Cython setuptools wheel
        pip install dist/scikit_surprise_2-*.tar.gz -v --no-build-isolation
    - name: Pip freeze
      run: |
        pip freeze
    - name: Run unit tests
      run: |
        pip install pandas tabulate pytest
        pytest -v
